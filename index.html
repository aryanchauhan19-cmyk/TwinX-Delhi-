<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>TwinX Delhi | Smart City Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;500;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/TextPlugin.min.js"></script>
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.42/dist/lenis.min.js"></script>

    <style>
        /* --- GLOBAL THEME --- */
        :root { 
            --neon-cyan: #00f2ff; 
            --neon-red: #ef4444; 
            --neon-green: #00ff41; 
            --neon-yellow: #fcee0a;
            --glass-bg: rgba(20, 25, 40, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #050a10; 
            font-family: 'Rajdhani', sans-serif; 
            color: var(--text-main);
            cursor: none; 
        }

        /* Fullscreen Map Container */
        #cesiumContainer {
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 1; opacity: 0;
        }

        /* --- 1. CUSTOM CURSOR --- */
        #cursor {
            position: fixed; top: 0; left: 0; width: 40px; height: 40px;
            border: 2px solid var(--neon-cyan); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 10000;
            box-shadow: 0 0 15px var(--neon-cyan);
            transition: width 0.2s, height 0.2s;
            mix-blend-mode: difference;
        }
        #cursor::after { 
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px;
            border-top: 2px solid var(--neon-cyan); border-bottom: 2px solid var(--neon-cyan);
            border-radius: 50%; transform: translate(-50%, -50%);
            animation: spin 2s linear infinite;
        }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- 2. LANDING LAYER --- */
        #landing-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; background: linear-gradient(to bottom, #1a1f24, #0d1216);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .fog-container { position: absolute; width: 100%; height: 100%; top: 0; left: 0; overflow: hidden; z-index: 1; }
        .fog-img {
            position: absolute; height: 100vh; width: 300vw;
            background: url('https://raw.githubusercontent.com/danielstuart14/CSS_FOG_ANIMATION/master/fog1.png') repeat-x;
            background-size: contain; animation: fogAnim 60s linear infinite;
        }
        .fog-img-2 {
            position: absolute; height: 100vh; width: 300vw;
            background: url('https://raw.githubusercontent.com/danielstuart14/CSS_FOG_ANIMATION/master/fog2.png') repeat-x;
            background-size: contain; animation: fogAnim 40s linear infinite reverse;
            z-index: 2; opacity: 0.5;
        }
        @keyframes fogAnim { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-200vw, 0, 0); } }

        .landing-ui { z-index: 10; text-align: center; position: relative; }
        .main-header { font-family: 'Orbitron', sans-serif; font-size: 80px; color: #fff; letter-spacing: -2px; margin-bottom: 40px; text-transform: uppercase; filter: blur(8px); transition: filter 0.5s ease; }
        .main-header:hover { filter: blur(0px); text-shadow: 0 0 30px var(--neon-cyan); }
        .init-btn { background: rgba(0,0,0,0.5); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 15px 40px; font-family: 'Rajdhani'; font-size: 18px; font-weight: 700; cursor: pointer; letter-spacing: 2px; text-transform: uppercase; transition: 0.3s; backdrop-filter: blur(5px); }
        .init-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 30px var(--neon-cyan); }

        .loader-container { width: 300px; display: none; z-index: 20; position: relative; margin-top: 30px; }
        .loader-bar { width: 100%; height: 2px; background: #333; position: relative; }
        .loader-progress { position: absolute; height: 100%; width: 0%; background: var(--neon-cyan); }
        .boot-text { color: var(--neon-green); font-size: 12px; margin-top: 10px; text-align: center; font-family: 'Orbitron'; }


        /* --- 3. TOP NAV & NOTIFICATIONS --- */
        .top-nav {
            position: fixed; top: 20px; left: 20px;
            z-index: 1000; display: flex; gap: 15px; opacity: 0; align-items: center;
        }
        .nav-btn {
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); color: #fff;
            padding: 10px 20px; border-radius: 30px; cursor: pointer;
            font-family: 'Rajdhani'; font-weight: 700; font-size: 13px;
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .nav-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px var(--neon-cyan); }
        .nav-btn.cost-btn { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        .nav-btn.cost-btn:hover { background: var(--neon-yellow); color: #000; }

        .search-wrapper { display: flex; align-items: center; background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 30px; padding: 5px 15px; transition: border-color 0.3s;}
        .search-wrapper:focus-within { border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 242, 255, 0.3); }
        .search-wrapper input { background: transparent; border: none; color: #fff; font-family: 'Rajdhani'; font-size: 14px; padding: 5px 10px; outline: none; width: 200px; }
        .search-wrapper button { background: transparent; border: none; color: var(--text-muted); cursor: pointer; transition: 0.3s; }
        .search-wrapper button:hover { color: var(--neon-cyan); transform: scale(1.1); }

        /* NOTIFICATION SYSTEM */
        #notification-container {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast-notification {
            background: rgba(10, 15, 20, 0.9);
            border-left: 4px solid var(--neon-cyan);
            border-radius: 4px; padding: 12px 20px; color: #fff;
            font-family: 'Rajdhani', sans-serif; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px);
            display: flex; align-items: center; gap: 12px;
            transform: translateX(120%); opacity: 0; min-width: 250px;
        }
        .toast-icon { font-size: 20px; }
        .toast-content { display: flex; flex-direction: column; }
        .toast-title { font-size: 10px; color: var(--text-muted); letter-spacing: 2px; margin-bottom: 2px;}
        .toast-msg { font-size: 14px; font-weight: 700; letter-spacing: 1px; }

        /* --- 4. CYBERPUNK HUD PANEL (LEFT) --- */
        #dashboard-panel {
            position: absolute; top: 90px; left: 20px; bottom: 20px; width: 360px;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 8px; z-index: 100; 
            display: flex; flex-direction: column; transform: translateX(-150%); overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.05);
        }
        .panel-header { padding: 20px; border-bottom: 1px solid rgba(0, 242, 255, 0.2); }
        .panel-title { font-family: 'Orbitron'; font-size: 18px; color: var(--neon-cyan); margin: 0; text-transform: uppercase; letter-spacing: 2px;}
        .panel-content { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: none; }
        .panel-content::-webkit-scrollbar { display: none; }

        /* Glowing Half-Arc Gauge */
        .aqi-container { display: flex; justify-content: center; margin-bottom: 35px; margin-top: 10px; }
        .half-gauge { position: relative; width: 220px; height: 110px; overflow: hidden; display: flex; justify-content: center; }
        .gauge-arc {
            position: absolute; top: 0; left: 0; width: 220px; height: 220px;
            border-radius: 50%; box-sizing: border-box;
            border: 10px solid rgba(255,255,255,0.05);
            border-bottom-color: transparent !important; border-left-color: transparent !important;
            transform: rotate(-45deg); transition: border-color 0.5s ease, box-shadow 0.5s ease;
            border-top-color: var(--neon-red); border-right-color: var(--neon-red);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5) inset;
        }
        .gauge-content { position: absolute; bottom: 0; display: flex; flex-direction: column; align-items: center; }
        .gauge-value { font-family: 'Roboto Mono', monospace; font-size: 60px; font-weight: 700; color: #fff; line-height: 0.9; text-shadow: 0 0 15px rgba(255,255,255,0.4); }
        .gauge-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-top: 5px; }
        .gauge-status { font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 700; margin-top: 2px; color: var(--neon-red); text-transform: uppercase; letter-spacing: 1px;}
        
        .pulse-alert { animation: pulseRed 1.5s infinite alternate; }
        @keyframes pulseRed { 0% { opacity: 1; text-shadow: 0 0 15px var(--neon-red); } 100% { opacity: 0.5; text-shadow: none; } }

        /* Tech Sliders */
        .control-group { margin-bottom: 25px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;}
        .label-row span:last-child { font-family: 'Roboto Mono', monospace; color: var(--neon-cyan); }
        input[type=range] { width: 100%; appearance: none; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: rgba(0, 242, 255, 0.3); border-radius: 0; box-shadow: 0 0 5px rgba(0, 242, 255, 0.4); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; height: 18px; width: 8px; border-radius: 2px; background: var(--neon-cyan); margin-top: -8px; box-shadow: 0 0 10px var(--neon-cyan); cursor: pointer; }

        /* Tactical Action Grid */
        .section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-bottom: 15px; border-left: 3px solid var(--neon-cyan); padding-left: 10px; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        
        .action-card {
            background: transparent; border: 1px solid rgba(0, 242, 255, 0.2);
            border-radius: 4px; padding: 12px; display: flex; flex-direction: column; align-items: center; gap: 6px;
            cursor: pointer; transition: all 0.3s ease; text-align: center;
        }
        .action-card i { font-size: 18px; color: rgba(255,255,255,0.3); transition: 0.3s; }
        .action-card span { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.5); font-family: 'Rajdhani', sans-serif; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;}
        
        .action-card:hover { border-color: rgba(0, 242, 255, 0.6); box-shadow: 0 0 10px rgba(0, 242, 255, 0.15) inset; }
        .action-card.active { background: rgba(0, 242, 255, 0.15); border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 242, 255, 0.4) inset, 0 0 10px rgba(0, 242, 255, 0.2); }
        .action-card.active i { color: var(--neon-cyan); text-shadow: 0 0 8px var(--neon-cyan); }
        .action-card.active span { color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.4); }

        /* HUD Budget Tracker */
        .budget-hud {
            margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255, 255, 255, 0.1); border-left: 3px solid var(--neon-yellow); border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center;
            font-family: 'Rajdhani', sans-serif; font-size: 13px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; color: #fff; transition: 0.3s;
        }

        /* --- 5. AI TERMINAL (BOTTOM RIGHT) --- */
        #ai-panel {
            position: absolute; bottom: 20px; right: 20px; width: 350px;
            background: rgba(10, 15, 20, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 255, 65, 0.3); border-left: 4px solid var(--neon-green);
            border-radius: 6px; z-index: 100; display: flex; flex-direction: column;
            padding: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            transform: translateX(150%); box-sizing: border-box;
        }
        .ai-header { font-family: 'Orbitron'; font-size: 14px; color: var(--neon-green); margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid rgba(0, 255, 65, 0.2); padding-bottom: 8px;}
        #chatLog { height: 120px; overflow-y: auto; font-size: 12px; margin-bottom: 10px; color: var(--neon-green); font-family: 'Roboto Mono', monospace; scrollbar-width: none;}
        #chatLog::-webkit-scrollbar { display: none; }
        .chat-input-row { display: flex; gap: 8px; align-items: center; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px; border: 1px solid #222;}
        #chatInput { flex: 1; background: transparent; border: none; padding: 5px; color: var(--neon-green); font-family: 'Roboto Mono', monospace; font-size: 12px; outline: none; }
        #chatInput::placeholder { color: rgba(0, 255, 65, 0.4); }
        .btn-send { background: rgba(0, 255, 65, 0.1); border: 1px solid var(--neon-green); color: var(--neon-green); cursor: pointer; font-weight: bold; border-radius: 2px; padding: 4px 10px; font-family: 'Roboto Mono', monospace; transition: 0.3s; text-transform: uppercase;}
        .btn-send:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 10px var(--neon-green); }


        /* --- AUDIT MODAL --- */
        #auditModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .audit-paper { background: #fdfdfd; color: #222; width: 600px; max-height: 90vh; overflow-y: auto; padding: 50px; box-shadow: 0 0 50px rgba(0,0,0,0.5); font-family: 'Courier Prime', monospace; position: relative; transform: rotate(-1deg); border: 1px solid #ccc; }
        .audit-paper::before { content: 'CONFIDENTIAL'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 80px; color: rgba(255,0,0,0.08); font-weight: bold; pointer-events: none; border: 8px solid rgba(255,0,0,0.08); padding: 20px; }
        .audit-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
        .audit-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 20px; }
        .audit-table th { text-align: left; border-bottom: 2px solid #000; padding: 10px 5px; font-weight: bold; }
        .audit-table td { padding: 10px 5px; border-bottom: 1px dotted #999; }
        .audit-total { font-weight: bold; font-size: 20px; border-top: 2px solid #000; margin-top: 20px; padding-top: 15px; display: flex; justify-content: space-between; }
        .audit-status { margin-top: 25px; padding: 15px; border: 2px solid #000; text-align: center; font-weight: bold; background: #eee; }
        .close-audit { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 28px; color: #000; font-weight: bold; }
        .close-audit:hover { color: red; }

        /* --- CENTER LOCATION & EMERGENCY ALERT --- */
        #location-alert-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            background: rgba(10, 15, 20, 0.95); border: 2px solid var(--neon-yellow);
            padding: 30px 50px; border-radius: 8px; z-index: 3000; opacity: 0; pointer-events: none;
            text-align: center; box-shadow: 0 0 50px rgba(252, 238, 10, 0.4); backdrop-filter: blur(10px);
            border-left: 8px solid var(--neon-yellow); transition: all 0.3s ease;
        }
        #location-alert-box.emergency-mode {
            border-color: var(--neon-red);
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.6);
            border-left: 8px solid var(--neon-red);
        }
        .loc-alert-title { font-family: 'Orbitron'; font-size: 24px; color: #fff; margin-bottom: 10px; letter-spacing: 2px;}
        .loc-alert-title span { color: var(--neon-yellow); font-weight: 900; }
        .emergency-mode .loc-alert-title span { color: var(--neon-red); }
        .loc-alert-desc { font-family: 'Rajdhani'; font-size: 20px; color: var(--neon-cyan); font-weight: bold; text-transform: uppercase; letter-spacing: 1px;}

        .cesium-viewer-geocoderContainer { display: none !important; }

    </style>
</head>
<body>

    <div id="cursor"></div>

    <div id="notification-container"></div>
    
    <div id="location-alert-box">
        <div class="loc-alert-title">TARGET ZONE: <span id="loc-alert-name"></span></div>
        <div class="loc-alert-desc" id="loc-alert-desc"></div>
    </div>

    <div id="landing-layer">
        <div class="fog-container">
            <div class="fog-img"></div>
            <div class="fog-img-2"></div>
        </div>

        <div class="landing-ui">
            <div style="font-size: 14px; letter-spacing: 4px; color: #888; margin-bottom: 10px; font-family: 'Rajdhani', sans-serif; font-weight: 600;">CDH DELHI PRESENTS</div>
            <h1 class="main-header">TWINX DELHI</h1>
            <button id="initBtn" class="init-btn" onclick="initializeSystem()">INITIALIZE SIMULATOR</button>
        </div>
        
        <div class="loader-container">
            <div class="loader-bar"><div class="loader-progress"></div></div>
            <div class="boot-text"></div>
        </div>
    </div>

    <div class="top-nav" style="display:none;" id="mainNav">
        <button class="nav-btn" id="heatmapBtn" onclick="toggleHeatmap()"><i class="fas fa-fire"></i> Heatmap</button>
        <button class="nav-btn cost-btn" onclick="openAudit()"><i class="fas fa-file-invoice-dollar"></i> Cost Analysis</button>
        <button class="nav-btn" onclick="toggleFullScreen()"><i class="fas fa-expand"></i> Fullscreen</button>
        
        <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="Search Location..." onkeypress="handleEnter(event)" autocomplete="off">
            <button onclick="searchLocation()" id="searchBtn"><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div id="dashboard-panel">
        <div class="panel-header">
            <h2 class="panel-title">Policy Engine</h2>
        </div>
        <div class="panel-content" id="panel-content">
            
            <div class="aqi-container">
                <div class="half-gauge">
                    <div class="gauge-arc" id="gaugeArc"></div>
                    <div class="gauge-content">
                        <div class="gauge-value" id="aqiDisplay">450</div>
                        <div class="gauge-label">Global AQI</div>
                        <div class="gauge-status pulse-alert" id="aqiStatus">Severe</div>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="label-row"><span>Pollution Base</span> <span id="aqiValDisplay">450</span></div>
                <input type="range" id="aqiSlider" min="50" max="600" value="450">
            </div>
            <div class="control-group">
                <div class="label-row"><span>Wind Dispersion</span> <span id="speedValDisplay">10</span></div>
                <input type="range" id="speedSlider" min="1" max="100" value="10">
            </div>

            <div class="section-title">Active Countermeasures</div>
            <div class="action-grid" id="policyGrid"></div>

            <div class="budget-hud" id="liveBudgetBox">
                <span>Live Expenditure:</span>
                <span id="hudBudgetTotal" style="color: var(--neon-green);">‚Çπ0</span>
            </div>

        </div>
    </div>

    <div id="ai-panel">
        <h3 class="ai-header"><i class="fas fa-robot"></i> AI Strategist</h3>
        <div id="chatLog">SYS_OP: Awaiting command sequence.<br>Hint: Type 'Connaught Place', 'WFH', or 'Diwali in Noida'.</div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" placeholder="_ Command..." autocomplete="off">
            <button class="btn-send" onclick="sendToAI()">EXEC</button>
        </div>
    </div>

    <div id="auditModal">
        <div class="audit-paper">
            <span class="close-audit" onclick="closeAudit()">&times;</span>
            <div class="audit-header">
                <h2>GOVT. EXPENDITURE REPORT</h2>
                <p>DEPARTMENT OF ENVIRONMENT</p>
                <p>DATE: <span id="auditDate"></span></p>
            </div>
            <table class="audit-table">
                <thead>
                    <tr>
                        <th>ITEM</th>
                        <th>QTY/DUR</th>
                        <th>COST (INR)</th>
                    </tr>
                </thead>
                <tbody id="auditList"></tbody>
            </table>
            <div class="audit-total">
                <span>GRAND TOTAL:</span>
                <span id="auditTotal" style="color:#d32f2f">‚Çπ0.00</span>
            </div>
            <div id="auditStatus" class="audit-status"></div>
        </div>
    </div>

    <div id="cesiumContainer"></div>

    <script>
        // --- CURSOR LOGIC ---
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', (e) => {
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        });

        document.querySelector('.main-header').addEventListener('mouseenter', () => {
            cursor.style.width = '80px'; cursor.style.height = '80px';
            cursor.style.mixBlendMode = 'normal'; cursor.style.boxShadow = '0 0 30px #fff'; cursor.style.borderColor = '#fff';
        });
        document.querySelector('.main-header').addEventListener('mouseleave', () => {
            cursor.style.width = '40px'; cursor.style.height = '40px';
            cursor.style.mixBlendMode = 'difference'; cursor.style.boxShadow = '0 0 15px var(--neon-cyan)'; cursor.style.borderColor = 'var(--neon-cyan)';
        });

        document.querySelector('.init-btn').addEventListener('mouseenter', () => {
            cursor.style.width = '60px'; cursor.style.height = '60px';
            cursor.style.mixBlendMode = 'normal'; cursor.style.borderColor = '#fff'; cursor.style.boxShadow = '0 0 20px #fff';
        });
        document.querySelector('.init-btn').addEventListener('mouseleave', () => {
            cursor.style.width = '40px'; cursor.style.height = '40px';
            cursor.style.mixBlendMode = 'difference'; cursor.style.borderColor = 'var(--neon-cyan)'; cursor.style.boxShadow = '0 0 15px var(--neon-cyan)';
        });

        // --- FULLSCREEN TOGGLE ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // --- SEARCH BAR LOGIC ---
        function handleEnter(e) { if(e.key === 'Enter') searchLocation(); }
        async function searchLocation() {
            const query = document.getElementById('searchInput').value;
            if(!query || !window.viewer) return;
            
            const btn = document.getElementById('searchBtn');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 

            try {
                const geocoder = new Cesium.IonGeocoderService({ scene: window.viewer.scene });
                const results = await geocoder.geocode(query);
                
                if(results && results.length > 0) {
                    window.viewer.camera.flyTo({
                        destination: results[0].destination,
                        duration: 2.5
                    });
                } else {
                    alert("Location not found.");
                }
            } catch(e) { 
                console.error("Search failed", e); 
            } finally {
                btn.innerHTML = originalIcon; 
            }
        }

        // --- DATA (COST, POLICY, & SENSORS) ---
        const POLICY_COSTS = {
            "smog_tower": { label: "Install Smog Tower", unit_cost: 220000000, monthly_opex: 1500000, type: "infrastructure", qty: 1 },
            "anti_smog_gun": { label: "Anti-Smog Gun", unit_cost: 0, monthly_opex: 60000, type: "rental", qty: 200 },
            "mech_sweeper": { label: "Mech. Road Sweeper", unit_cost: 5000000, monthly_opex: 150000, type: "fleet", qty: 50 },
            "odd_even": { label: "Odd-Even Scheme", unit_cost: 0, monthly_opex: 200000000, type: "policy", qty: 1 },
            "construction_ban": { label: "Worker Compensation", unit_cost: 0, monthly_opex: 2500000000, type: "welfare", qty: 1 },
            "wfh": { label: "WFH Govt. Subsidy", unit_cost: 0, monthly_opex: 100000000, type: "policy", qty: 1 }
        };

        const POLICY_UI_CONFIG = {
            "odd_even": { label: "Odd-Even", impact: 15, icon: "fa-car-side", costKey: "odd_even" },
            "construction_ban": { label: "No Constr.", impact: 45, icon: "fa-trowel-bricks", costKey: "construction_ban" },
            "smog_tower": { label: "Smog Tower", impact: 5, icon: "fa-fan", costKey: "smog_tower" },
            "mech_sweeper": { label: "Mech Sweep", impact: 10, icon: "fa-truck-monster", costKey: "mech_sweeper" },
            "anti_smog_gun": { label: "Smog Guns", impact: 8, icon: "fa-shower", costKey: "anti_smog_gun" },
            "wfh": { label: "WFH Mode", impact: 12, icon: "fa-laptop-house", costKey: "wfh" }
        };

        const dpccStationData = [
          { id: "DPCC-001", lat: 28.6469, lng: 77.3160, color: '#ff3300' }, 
          { id: "DPCC-002", lat: 28.5632, lng: 77.1869, color: '#ffaa00' }, 
          { id: "DPCC-003", lat: 28.5306, lng: 77.2714, color: '#ff5500' }, 
          { id: "DPCC-004", lat: 28.6619, lng: 77.1242, color: '#ff8800' }, 
          { id: "DPCC-005", lat: 28.6328, lng: 77.2197, color: '#ff0000' }  
        ];

        const State = { aqi: 450, baseAqi: 450, currentDisplayAqi: 450, activePolicies: new Set(), windSpeed: 10, heatmapEntities: [], isHeatmapShowing: false, auditTimer: null };

        // --- NOTIFICATION SYSTEM ---
        function showNotification(actionName, isEngaged) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            
            const color = isEngaged ? 'var(--neon-green)' : 'var(--neon-red)';
            const statusText = isEngaged ? 'PROTOCOL ENGAGED' : 'PROTOCOL SUSPENDED';
            const icon = isEngaged ? 'fa-lock' : 'fa-unlock';
            const subtext = isEngaged ? 'Resources Locked' : 'Resources Released';

            toast.style.borderLeftColor = color;
            toast.style.boxShadow = `0 0 15px ${color}40`;

            toast.innerHTML = `
                <i class="fas ${icon} toast-icon" style="color:${color};"></i>
                <div class="toast-content">
                    <span class="toast-title">${statusText}</span>
                    <span class="toast-msg" style="color:${color};">${actionName}</span>
                    <span style="font-size:10px; color:#888; margin-top:2px;">SYS: ${subtext}</span>
                </div>
            `;
            
            container.appendChild(toast);

            // Animate IN
            gsap.to(toast, { x: 0, opacity: 1, duration: 0.5, ease: "back.out(1.2)" });

            // Animate OUT
            setTimeout(() => {
                gsap.to(toast, { 
                    x: "120%", opacity: 0, duration: 0.4, ease: "power2.in", 
                    onComplete: () => toast.remove() 
                });
            }, 3500);
        }

        // --- CENTER HUD ALERT FOR LOCATIONS & EMERGENCIES ---
        function triggerLocationAlert(locationName, policyKeys, isEmergency = false) {
            const policyNames = policyKeys.map(k => POLICY_UI_CONFIG[k].label).join(' + ');
            const box = document.getElementById('location-alert-box');
            const desc = document.getElementById('loc-alert-desc');
            
            if (isEmergency) {
                box.classList.add('emergency-mode');
                document.querySelector('.loc-alert-title').innerHTML = `üö® EMERGENCY PROTOCOL: <span id="loc-alert-name">${locationName.toUpperCase()}</span> üö®`;
            } else {
                box.classList.remove('emergency-mode');
                document.querySelector('.loc-alert-title').innerHTML = `TARGET ZONE: <span id="loc-alert-name">${locationName.toUpperCase()}</span>`;
            }
            
            desc.innerText = `POLICIES DEPLOYED: ${policyNames}`;
            
            // Pop in
            gsap.to(box, {opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.5)"});
            
            // Fade out after 4 seconds
            setTimeout(() => {
                gsap.to(box, {opacity: 0, scale: 0.8, duration: 0.5});
            }, 4000);
        }

        // --- HEATMAP LOGIC (OWM + LOCAL 3D ZONES) ---
        let owmHeatmapLayer;
        function toggleHeatmap() {
            let isShowing = false;
            
            if(owmHeatmapLayer) {
                owmHeatmapLayer.show = !owmHeatmapLayer.show;
                isShowing = owmHeatmapLayer.show;
            } else {
                State.isHeatmapShowing = !State.isHeatmapShowing;
                isShowing = State.isHeatmapShowing;
            }

            State.heatmapEntities.forEach(entity => {
                entity.show = isShowing;
            });

            const btn = document.getElementById('heatmapBtn');
            if(isShowing) {
                btn.style.background = 'var(--neon-red)';
                btn.style.color = '#fff';
                btn.style.borderColor = 'var(--neon-red)';
                btn.style.boxShadow = '0 0 20px var(--neon-red)';
                showNotification("Thermal Heatmap", true);
            } else {
                btn.style.background = 'var(--glass-bg)';
                btn.style.color = '#fff';
                btn.style.borderColor = 'var(--glass-border)';
                btn.style.boxShadow = 'none';
                showNotification("Thermal Heatmap", false);
            }
        }

        // --- SYNTHETIC 3D ZONAL HEATMAP SETUP ---
        function setupZonalHeatmap(viewer) {
            dpccStationData.forEach(station => {
                const entity = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(station.lng, station.lat),
                    show: false, 
                    ellipse: {
                        semiMinorAxis: 2500.0, 
                        semiMajorAxis: 2500.0,
                        material: new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(() => {
                            const factor = Math.min(State.aqi / 500, 1.0);
                            const baseColor = Cesium.Color.lerp(
                                Cesium.Color.fromCssColorString('#00ff88'), 
                                Cesium.Color.fromCssColorString(station.color), 
                                factor, new Cesium.Color()
                            );
                            return baseColor.withAlpha(0.4); 
                        }, false))
                    }
                });
                State.heatmapEntities.push(entity);
            });
        }

        // --- POLICY UI GENERATION ---
        function generatePolicies() {
            const grid = document.getElementById('policyGrid');
            grid.innerHTML = '';
            for (const [key, data] of Object.entries(POLICY_UI_CONFIG)) {
                const card = document.createElement('div');
                card.className = 'action-card';
                card.id = `card_${key}`;
                card.onclick = () => togglePolicy(key, card);
                card.innerHTML = `<i class="fas ${data.icon}"></i><span>${data.label}</span>`;
                grid.appendChild(card);
            }
        }

        // --- BOOT SEQUENCE ---
        function initializeSystem() {
            gsap.to(".init-btn", { opacity: 0, pointerEvents: "none", duration: 0.3 });
            gsap.to(".main-header", { opacity: 0, scale: 1.5, filter: "blur(20px)", duration: 0.5 });
            gsap.to(".fog-container", { scale: 3, opacity: 0, duration: 2, ease: "power2.in" });

            document.querySelector('.loader-container').style.display = 'block';
            const tl = gsap.timeline({onComplete: revealDashboard});
            
            tl.to(".loader-progress", {width: "100%", duration: 2, ease: "power2.inOut"})
              .to(".boot-text", {text: "PURIFYING AIR FILTERS...", duration: 0.5}, "<")
              .to(".boot-text", {text: "LOADING CITY TWIN...", duration: 0.8}, ">")
              .to(".boot-text", {text: "SYSTEM ONLINE.", color: "#00ff41", duration: 0.5}, ">");
        }

        function revealDashboard() {
            gsap.to("#landing-layer", {y: "-100%", duration: 1.2, ease: "power4.inOut"});
            document.body.style.cursor = "auto";
            document.getElementById('cursor').style.display = "none";
            
            gsap.to("#cesiumContainer", {opacity: 1, duration: 1});
            
            document.getElementById('mainNav').style.display = 'flex';
            gsap.to(".top-nav", {opacity: 1, y: 0, duration: 0.8, delay: 0.4});
            
            gsap.to("#dashboard-panel", {x: 0, duration: 0.8, delay: 0.6, ease: "back.out(1.2)"});
            
            // Show AI Terminal (Bottom Right)
            gsap.to("#ai-panel", {x: 0, duration: 0.8, delay: 0.8, ease: "back.out(1.2)"});
            
            initCesium();
            generatePolicies();
        }

        // --- HUD BUDGET UPDATE LOGIC ---
        function updateBudgetHUD() {
            let grandTotal = 0;
            State.activePolicies.forEach(uiKey => {
                const costKey = POLICY_UI_CONFIG[uiKey].costKey;
                const costData = POLICY_COSTS[costKey];
                if(costData) {
                    let itemTotal = costData.type === "infrastructure" ? (costData.unit_cost * costData.qty) + costData.monthly_opex : (costData.monthly_opex * costData.qty);
                    if (costData.type === "policy" || costData.type === "welfare") itemTotal = costData.monthly_opex;
                    grandTotal += itemTotal;
                }
            });
            
            const hudEl = document.getElementById('hudBudgetTotal');
            const hudBox = document.getElementById('liveBudgetBox');
            
            hudEl.innerText = `‚Çπ${grandTotal.toLocaleString()}`;
            
            if (grandTotal > 3000000000) {
                hudEl.style.color = "var(--neon-red)";
                hudBox.style.borderLeftColor = "var(--neon-red)";
                hudBox.style.boxShadow = "0 0 15px rgba(239, 68, 68, 0.3) inset";
            } else {
                hudEl.style.color = "var(--neon-green)";
                hudBox.style.borderLeftColor = "var(--neon-yellow)";
                hudBox.style.boxShadow = "none";
            }
        }

        // --- DASHBOARD LOGIC (AUTO-AUDIT POPUP INCLUDED) ---
        function togglePolicy(key, card) {
            let isEngaged = false;
            if (State.activePolicies.has(key)) {
                State.activePolicies.delete(key);
                isEngaged = false;
            } else {
                State.activePolicies.add(key);
                isEngaged = true;
            }
            
            card.classList.toggle('active');
            
            // 1. Show the holographic notification toast
            showNotification(POLICY_UI_CONFIG[key].label, isEngaged);

            // 2. Recalculate
            recalcImpact();

            // 3. Automatically pop up the full Cost Analysis paper after 10 seconds!
            clearTimeout(State.auditTimer);
            State.auditTimer = setTimeout(() => {
                openAudit();
            }, 10000); 
        }

        function recalcImpact() {
            let totalReduction = 0;
            State.activePolicies.forEach(key => totalReduction += POLICY_UI_CONFIG[key].impact);
            let windBonus = State.windSpeed * 0.5; 
            State.aqi = Math.max(40, State.baseAqi - totalReduction - windBonus);
            
            gsap.to(State, {
                currentDisplayAqi: State.aqi,
                duration: 2,
                ease: "power2.out",
                onUpdate: () => {
                    updateGaugeVisuals(State.currentDisplayAqi);
                }
            });

            updateBudgetHUD();
        }

        // --- GAUGE LOGIC (HALF-ARC) ---
        function updateGaugeVisuals(aqiVal) {
            const display = document.getElementById('aqiDisplay');
            const status = document.getElementById('aqiStatus');
            const arc = document.getElementById('gaugeArc');
            
            display.innerText = Math.round(aqiVal);
            
            let color = '#00ff88'; 
            let label = 'Good';
            let isSevere = false;

            if (aqiVal > 50) { color = '#fcee0a'; label = 'Moderate'; }
            if (aqiVal > 100) { color = '#ff9900'; label = 'Poor'; }
            if (aqiVal > 200) { color = '#ef4444'; label = 'Severe'; isSevere = true; }

            status.innerText = label; 
            status.style.color = color;
            
            if(isSevere) {
                status.classList.add('pulse-alert');
            } else {
                status.classList.remove('pulse-alert');
            }

            if(arc) {
                arc.style.borderTopColor = color;
                arc.style.borderRightColor = color;
                arc.style.boxShadow = `0 0 20px ${color}80 inset`; 
            }

            if(window.viewer) {
                const density = (aqiVal / 500) * 0.0025;
                window.viewer.scene.fog.density = density;
                
                const factor = Math.min(aqiVal / 500, 1.0);
                window.viewer.scene.fog.color = Cesium.Color.lerp(
                    Cesium.Color.fromCssColorString('#a4c2f4'), 
                    Cesium.Color.fromCssColorString('#8b7b6b'), 
                    factor, new Cesium.Color()
                );
            }
        }

        // --- CESIUM MAP INIT ---
        async function initCesium() {
            if(window.viewer) return;
            Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3MzI3MGIyZS1jZDEwLTRiOTYtOTJjNS1mZTFlOGVkNDg4NzUiLCJpZCI6Mzg1NzcyLCJpYXQiOjE3Njk5NDc2NTJ9.fvUHQUlAGhWQE_8fClYm3sWd0pnmkD7bKYUjQfrA_5g';
            try {
                window.viewer = new Cesium.Viewer('cesiumContainer', {
                    terrainProvider: await Cesium.createWorldTerrainAsync(),
                    baseLayerPicker: false, animation: false, timeline: false, 
                    selectionIndicator: false, infoBox: false, geocoder: false, homeButton: false, sceneModePicker: false
                });

                const buildings = await Cesium.createOsmBuildingsAsync();
                window.viewer.scene.primitives.add(buildings);
                
                window.viewer.scene.fog.enabled = true;
                window.viewer.scene.fog.minimumBrightness = 0.8;
                window.viewer.scene.skyAtmosphere.hueShift = -0.1;

                try {
                    const owmProvider = new Cesium.UrlTemplateImageryProvider({
                        url: 'https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=171d13993e3c16cfcabf9e2c677c49a3a4abde43',
                        maximumLevel: 18, 
                        credit: 'OpenWeatherMap'
                    });
                    owmHeatmapLayer = window.viewer.imageryLayers.addImageryProvider(owmProvider);
                    owmHeatmapLayer.alpha = 0.55;
                    owmHeatmapLayer.show = false; 
                } catch(err) { console.log("OWM Heatmap Error:", err); }

                setupZonalHeatmap(window.viewer);

                // ADJUSTED CONNAUGHT PLACE FLIGHT
                window.viewer.camera.flyTo({ 
                    destination: Cesium.Cartesian3.fromDegrees(77.2190, 28.6250, 1600), 
                    orientation: { 
                        heading: Cesium.Math.toRadians(0), 
                        pitch: Cesium.Math.toRadians(-45)  
                    },
                    duration: 3
                });

            } catch (e) { console.log("Cesium Error:", e); }
        }

        document.getElementById('aqiSlider').oninput = (e) => {
            State.aqi = parseInt(e.target.value);
            State.baseAqi = State.aqi; 
            document.getElementById('aqiValDisplay').innerText = State.aqi;
            updateGaugeVisuals(State.aqi);
        };
        
        document.getElementById('speedSlider').oninput = (e) => {
            State.windSpeed = parseInt(e.target.value);
            document.getElementById('speedValDisplay').innerText = State.windSpeed;
            recalcImpact();
        };


        // --- AUDIT MODAL LOGIC ---
        function openAudit() {
            const modal = document.getElementById('auditModal');
            const list = document.getElementById('auditList');
            const totalEl = document.getElementById('auditTotal');
            const statusEl = document.getElementById('auditStatus');
            document.getElementById('auditDate').innerText = new Date().toLocaleDateString();
            list.innerHTML = '';
            let grandTotal = 0;

            if(State.activePolicies.size === 0) {
                list.innerHTML = '<tr><td colspan="3" style="text-align:center;">NO ACTIVE POLICIES</td></tr>';
            } else {
                State.activePolicies.forEach(uiKey => {
                    const costKey = POLICY_UI_CONFIG[uiKey].costKey;
                    const costData = POLICY_COSTS[costKey];
                    if(costData) {
                        let itemTotal = costData.type === "infrastructure" ? (costData.unit_cost * costData.qty) + costData.monthly_opex : (costData.monthly_opex * costData.qty);
                        if (costData.type === "policy" || costData.type === "welfare") itemTotal = costData.monthly_opex;
                        grandTotal += itemTotal;
                        list.innerHTML += `<tr><td>${costData.label}</td><td>${costData.qty} Units/15 Days</td><td>‚Çπ${itemTotal.toLocaleString()}</td></tr>`;
                    }
                });
            }
            totalEl.innerText = `‚Çπ${grandTotal.toLocaleString()}`;
            const BUDGET_LIMIT = 3000000000;
            if (grandTotal < BUDGET_LIMIT) {
                statusEl.innerHTML = "‚úÖ APPROVED<br>Within Dept Budget (‚Çπ506 Cr)";
                statusEl.style.color = "green"; statusEl.style.borderColor = "green"; statusEl.style.background = "#e8f5e9";
            } else {
                statusEl.innerHTML = "‚ö†Ô∏è OVER BUDGET<br>Requires Central Govt. Funds (> ‚Çπ300 Cr)";
                statusEl.style.color = "red"; statusEl.style.borderColor = "red"; statusEl.style.background = "#ffebee";
            }
            modal.style.display = "flex";
        }
        function closeAudit() { document.getElementById('auditModal').style.display = "none"; }


        // --- EXPANDED TERMINAL CHAT AI WITH EMERGENCY LOGIC ---
        const API_KEY = "YOUR_GEMINI_API_KEY_HERE"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3.0-flash:generateContent?key=${API_KEY}`;

        // Hardcoded location list to detect user input
        const DELHI_LOCATIONS = [
            'bawana', 'wazirpur', 'okhla', 'narela', 'mayapuri', 'naraina', 'anand vihar', 'jahangirpuri', 'patparganj', 'jhilmil', 'badli',
            'connaught place', 'cp', 'karol bagh', 'lajpat nagar', 'chandni chowk', 'sarojini nagar', 'south ex', 'sadar bazaar', 'rajouri garden',
            'nehru place', 'cyber city', 'gurgaon', 'noida electronic city', 'aerocity', 'udyog vihar', 'noida',
            'dwarka', 'rohini', 'vasant kunj', 'najafgarh', 'burari',
            'india gate', 'lutyens', 'chanakyapuri', 'parliament', 'greater kailash', 'gk', 'hauz khas', 'defence colony'
        ];

        async function sendToAI() {
            const input = document.getElementById("chatInput");
            const log = document.getElementById("chatLog");
            const userText = input.value.trim();
            if (!userText) return;

            // Log user input
            log.innerHTML += `<div style="color:#fff; margin-top:5px;">> ${userText}</div>`;
            input.value = ""; log.scrollTop = log.scrollHeight;

            const lowerInput = userText.toLowerCase();
            
            // Detection flags
            let detectedLoc = DELHI_LOCATIONS.find(loc => lowerInput.includes(loc));
            let isFestival = lowerInput.includes('diwali') || lowerInput.includes('dussehra') || lowerInput.includes('festival') || lowerInput.includes('firecracker') || lowerInput.includes('cracker');

            let matchedPolicies = [];
            let replyMessage = "";

            // --- 1. LOCAL FALLBACK LOGIC ---
            
            // 0. FESTIVAL EMERGENCY (Overrides standard locations)
            if (isFestival) {
                matchedPolicies = ['anti_smog_gun', 'mech_sweeper', 'construction_ban', 'smog_tower'];
                replyMessage = `CRITICAL ALERT: Festival emission spike detected. Activating severe GRAP measures. Deploying Anti-Smog Guns, Mech Sweepers, and Smog Towers immediately${detectedLoc ? ` in ${detectedLoc.toUpperCase()}` : ' across the city'}.`;
            }
            // 1. Industrial & Severe Pollution Hotspots
            else if (lowerInput.includes('bawana') || lowerInput.includes('wazirpur') || lowerInput.includes('okhla') || lowerInput.includes('narela') || lowerInput.includes('mayapuri') || lowerInput.includes('naraina') || lowerInput.includes('anand vihar') || lowerInput.includes('jahangirpuri') || lowerInput.includes('patparganj') || lowerInput.includes('jhilmil') || lowerInput.includes('badli')) {
                matchedPolicies = ['smog_tower', 'mech_sweeper'];
                replyMessage = "Severe industrial/hotspot zone detected. Deploying Heavy-Duty Smog Towers and Mechanical Sweepers to neutralize industrial particulate matter and settle toxic dust.";
            } 
            // 2. Commercial & High Traffic Markets
            else if (lowerInput.includes('connaught place') || lowerInput.includes('cp') || lowerInput.includes('karol bagh') || lowerInput.includes('lajpat nagar') || lowerInput.includes('chandni chowk') || lowerInput.includes('sarojini nagar') || lowerInput.includes('south ex') || lowerInput.includes('sadar bazaar') || lowerInput.includes('rajouri garden')) {
                matchedPolicies = ['odd_even', 'anti_smog_gun'];
                replyMessage = "High-density commercial market detected. Implementing Odd-Even to slash vehicular congestion and deploying Anti-Smog Guns for localized dust suppression.";
            }
            // 3. Corporate & IT Hubs
            else if (lowerInput.includes('nehru place') || lowerInput.includes('cyber city') || lowerInput.includes('gurgaon') || lowerInput.includes('noida electronic city') || lowerInput.includes('aerocity') || lowerInput.includes('udyog vihar') || lowerInput.includes('noida')) {
                matchedPolicies = ['wfh'];
                replyMessage = "Major Corporate/IT hub detected. Mandating Work From Home (WFH) to drastically reduce peak-hour commuter traffic and emissions. Expected AQI drop applied.";
            }
            // 4. Heavy Construction & Expanding Residential
            else if (lowerInput.includes('dwarka') || lowerInput.includes('rohini') || lowerInput.includes('vasant kunj') || lowerInput.includes('najafgarh') || lowerInput.includes('burari')) {
                matchedPolicies = ['construction_ban', 'anti_smog_gun'];
                replyMessage = "Extensive residential/construction zone identified. Initiating immediate Construction Ban and deploying Anti-Smog Guns to control fugitive cement and soil dust.";
            }
            // 5. VIP, Diplomatic & Premium Residential
            else if (lowerInput.includes('india gate') || lowerInput.includes('lutyens') || lowerInput.includes('chanakyapuri') || lowerInput.includes('parliament') || lowerInput.includes('greater kailash') || lowerInput.includes('gk') || lowerInput.includes('hauz khas') || lowerInput.includes('defence colony')) {
                matchedPolicies = ['mech_sweeper', 'wfh'];
                replyMessage = "Central/Premium zone detected. Deploying targeted Mechanical Sweepers for ambient dust control and mandating WFH for non-essential staff.";
            }
            // 6. Generic / Emergency Commands
            else if (lowerInput.includes('grap') || lowerInput.includes('stage 4') || lowerInput.includes('emergency')) {
                matchedPolicies = ['construction_ban', 'wfh', 'odd_even'];
                replyMessage = "GRAP Stage 4 Activated. Halting public projects, restricting traffic, and enforcing WFH. Expected AQI drop: 15%.";
            } else if (lowerInput.includes('sprinkler') || lowerInput.includes('water') || lowerInput.includes('gun')) {
                matchedPolicies = ['anti_smog_gun', 'mech_sweeper'];
                replyMessage = "Deploying Anti-Smog Guns and Mechanical Sweepers to suppress road dust and particulate matter.";
            } else if (lowerInput.includes('traffic') || lowerInput.includes('car') || lowerInput.includes('vehicle')) {
                matchedPolicies = ['odd_even'];
                replyMessage = "Implementing Odd-Even traffic rationing to reduce vehicular emissions.";
            } else if (lowerInput.includes('construction') || lowerInput.includes('build') || lowerInput.includes('dust')) {
                matchedPolicies = ['construction_ban'];
                replyMessage = "Initiating strict ban on all non-essential construction and demolition activities.";
            } else if (lowerInput.includes('tower') || lowerInput.includes('filter') || lowerInput.includes('purify')) {
                matchedPolicies = ['smog_tower'];
                replyMessage = "Activating central Smog Towers for localized air purification.";
            } else if (lowerInput.includes('work from home') || lowerInput.includes('wfh') || lowerInput.includes('remote') || lowerInput.includes('office')) {
                matchedPolicies = ['wfh'];
                replyMessage = "Mandating 50% Work From Home for corporate and government offices.";
            } else {
                matchedPolicies = ['anti_smog_gun', 'smog_tower'];
                replyMessage = "General pollution reduction initiated. Activating localized purification and dust suppression protocols.";
            }

            // Execute local fallback if API key is missing
            if (API_KEY === "YOUR_GEMINI_API_KEY_HERE" || API_KEY === "") {
                setTimeout(() => {
                    let anyActivated = false;
                    matchedPolicies.forEach(id => {
                        const card = document.getElementById(`card_${id}`);
                        if(card && !card.classList.contains('active')) {
                            togglePolicy(id, card); 
                            anyActivated = true;
                        }
                    });
                    
                    if(!anyActivated) {
                         log.innerHTML += `<div style="color:var(--neon-yellow); margin-top:5px;">SYS_REPLY: Recommended policies are already active.</div>`;
                    } else {
                         log.innerHTML += `<div style="color:var(--neon-green); margin-top:5px;">SYS_REPLY: ${replyMessage}</div>`;
                         
                         // Trigger visually striking alert
                         if (isFestival) {
                             triggerLocationAlert(detectedLoc ? `${detectedLoc}` : "CITY-WIDE EVENT", matchedPolicies, true);
                         } else if (detectedLoc) {
                             triggerLocationAlert(detectedLoc, matchedPolicies, false);
                         }
                    }
                    log.scrollTop = log.scrollHeight;
                }, 800); 
                return; 
            }

            // --- 2. DYNAMIC AI LOGIC (Used if API key is present) ---
            const prompt = `
                System: You are an Expert Policy Advisor for Delhi NCR Pollution Control.
                User Input: '${userText}'
                Available Action Keys: ["odd_even", "construction_ban", "smog_tower", "mech_sweeper", "anti_smog_gun", "wfh"].
                Contextual Rules: 
                1. If the user mentions an Indian festival (like Diwali, Dussehra) or fireworks/crackers, immediately trigger a "FESTIVAL EMERGENCY PROTOCOL". Recommend aggressive measures like ["anti_smog_gun", "mech_sweeper", "smog_tower", "construction_ban"].
                2. If the user mentions a specific location (e.g., "Noida Electronic City", "Okhla"), recommend the most effective localized policies based on its characteristics (corporate hub, heavy industrial, etc.).
                3. If BOTH a festival and location are mentioned, apply the aggressive emergency measures specifically to that location.
                Output Rule: Return ONLY a valid JSON object.
                Format: {"recommend": ["action_key_1", "action_key_2"], "is_emergency": true/false, "reason": "Short explanation mentioning the location and event characteristics."}
            `;
            
            try {
                const response = await fetch(API_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) 
                });
                
                const data = await response.json();
                
                if(data.error) {
                    log.innerHTML += `<div style="color:red; margin-top:5px;">ERR_CONN: API Key Invalid or Quota Reached.</div>`;
                    log.scrollTop = log.scrollHeight;
                    return;
                }

                let raw = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const res = JSON.parse(raw);
                
                let anyActivated = false;
                if(res.recommend && Array.isArray(res.recommend)) {
                    res.recommend.forEach(id => {
                        const card = document.getElementById(`card_${id}`);
                        if(card && !card.classList.contains('active')) {
                            togglePolicy(id, card);
                            anyActivated = true;
                        }
                    });
                }
                
                log.innerHTML += `<div style="color:var(--neon-green); margin-top:5px;">SYS_REPLY: ${res.reason}</div>`;
                
                if (anyActivated) {
                    if (res.is_emergency) {
                        triggerLocationAlert(detectedLoc ? detectedLoc : "FESTIVAL ZONE", res.recommend, true);
                    } else if (detectedLoc) {
                        triggerLocationAlert(detectedLoc, res.recommend, false);
                    }
                }
                
            } catch (e) { 
                log.innerHTML += `<div style="color:red; margin-top:5px;">ERR_CONN: AI OFFLINE.</div>`; 
            }
            log.scrollTop = log.scrollHeight;
        }

        document.getElementById('chatInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') { sendToAI(); }
        });

    </script>
</body>
</html>